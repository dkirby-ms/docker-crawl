# Builder image
FROM ubuntu:20.04 AS builder

# Variables
ENV CRAWL_REPO="https://github.com/crawl/crawl.git" \
  APP_DEPS="bzip2 liblua5.1-0-dev python3-minimal python3-pip python3-yaml \
    python-is-python3 ncurses-term locales-all sqlite3 libpcre3 locales \
    lsof sudo libbot-basicbot-perl" \
  BUILD_DEPS="autoconf bison build-essential flex git libncursesw5-dev \
    libsqlite3-dev libz-dev pkg-config binutils-gold libsdl2-image-dev libsdl2-mixer-dev \
    libsdl2-dev libfreetype6-dev libpng-dev ttf-dejavu-core advancecomp pngcrush" \
  DEBIAN_FRONTEND=noninteractive

# Install packages for the build
RUN apt-get update && \
  apt-get upgrade -y && \
  apt-get install -y ${BUILD_DEPS} ${APP_DEPS}

# Retrieve crawl 0.26
RUN git clone ${CRAWL_REPO} /src/ && \
    cd src && \
    git fetch origin && \
    git checkout stone_soup-0.26 && \
    git pull

# Build crawl
RUN cd /src/crawl-ref/source && \
  make install -j4 DESTDIR=/app/ USE_DGAMELAUNCH=y WEBTILES=y

# Set up webserver components
RUN cp -r /src/crawl-ref/source/webserver /app/ && \
  cp -r /src/crawl-ref/source/util /app/

# Runtime image
FROM ubuntu:20.04

# Environment Variables
ENV APP_DEPS="bzip2 liblua5.1-0-dev python3-minimal python3-pip python3-yaml \
    python-is-python3 ncurses-term locales-all sqlite3 libpcre3 locales \
    lsof sudo libbot-basicbot-perl" \
  DATA_DIR=/data \
  DEBIAN_FRONTEND=noninteractive

# Install packages for the runtime
RUN apt-get update && \
  apt-get upgrade -y && \
  apt-get install -y ${APP_DEPS}

# Install Tornado
RUN pip3 install tornado PyYaML azure-identity azure-keyvault-secrets msal torndsession

# Copy over the compiled files
COPY --from=builder /app/ /app/

# Copy over custom configs
COPY webserver/v26.config.py /app/webserver/config.py

# Copy over OAuth code for AAD B2C support
COPY settings/init.txt /app/settings/
COPY util/webtiles-init-player.sh /app/util/
COPY webserver/aad_b2c.py /app/webserver/aad_b2c.py
COPY webserver/auth.py /app/webserver/auth.py
COPY webserver/server.py /app/webserver/server.py
COPY webserver/games.d/* /app/webserver/games.d/
COPY webserver/templates/client.html /app/webserver/templates/client.html
COPY webserver/templates/banner.html /app/webserver/templates/banner.html
COPY webserver/templates/game_links.html /app/webserver/templates/game_links.html
RUN chmod 700 /app/webserver/server.py

# Set Crawl version for container to use
ENV CRAWLVERSION="0.26"

# Copy over the entrypoint
COPY scripts/entrypoint-webtiles.sh /app/entrypoint.sh

# Clean up unnecessary package lists
RUN rm -rf /var/lib/apt/lists/*

# Expose ports
EXPOSE 8080

# Set the WORKDIR
WORKDIR /app

# Launch WebTiles server
ENTRYPOINT [ "./entrypoint.sh" ]